<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>pylab.metropolis API documentation</title>
    <meta name="description" content="Metropolis-Hasting Classes

These track the acceptance rate and sets backend pointers

These are onl..." />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>


  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>
      
  <ul>
    <li class="mono"><a href="#pylab.metropolis.DEFAULT_END_TUNING">DEFAULT_END_TUNING</a></li>
    <li class="mono"><a href="#pylab.metropolis.DEFAULT_TARGET_ACCEPTANCE_RATE">DEFAULT_TARGET_ACCEPTANCE_RATE</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#pylab.metropolis.acceptance_rate">acceptance_rate</a></li>
    <li class="mono"><a href="#pylab.metropolis.isMetropKernel">isMetropKernel</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#pylab.metropolis.NormalKernel">NormalKernel</a></span>
        
          
  <ul>
    <li class="mono"><a href="#pylab.metropolis.NormalKernel.__init__">__init__</a></li>
    <li class="mono"><a href="#pylab.metropolis.NormalKernel.accept">accept</a></li>
    <li class="mono"><a href="#pylab.metropolis.NormalKernel.acceptance_rate">acceptance_rate</a></li>
    <li class="mono"><a href="#pylab.metropolis.NormalKernel.proposal_norm">proposal_norm</a></li>
    <li class="mono"><a href="#pylab.metropolis.NormalKernel.reject">reject</a></li>
    <li class="mono"><a href="#pylab.metropolis.NormalKernel.step">step</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">pylab.metropolis</span> module</h1>
  <p>Metropolis-Hasting Classes</p>
<p>These track the acceptance rate and sets backend pointers</p>
<p>These are only for scalars.</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pylab.metropolis', this);">Show source &equiv;</a></p>
  <div id="source-pylab.metropolis" class="source">
    <pre><code>'''Metropolis-Hasting Classes

These track the acceptance rate and sets backend pointers

These are only for scalars.
'''

import numpy.random as npr
import numpy as np
import sys
import logging

from . import util
from . import variables
from .errors import MathError

# Constants
DEFAULT_TARGET_ACCEPTANCE_RATE = 'auto'
DEFAULT_END_TUNING = 'auto'

def isMetropKernel(a):
    '''Checks if `a` is a MetropolisKernel

    Parameters
    ----------
    a : any
        Instance we are checking

    Returns
    -------
    bool
        True if `a` is a MetropolisKernel
    '''
    return a is not None and issubclass(a.__class__, _BaseKernel)

def _sum_look_back(trace):
    '''Inner function
    
    Makes a boolean array for the accept/reject based on the values in the
    array. Always say the first element was accepted.

    Parameters
    ----------
    trace : array
        Trace to look at

    Returns
    -------
    int
        Number of accepts over the trace
    '''
    ret = 1
    for i in range(1,len(trace)):
        ret += trace[i]!=trace[i-1]
    return ret

def acceptance_rate(x, start, end):
    '''Calculate the acceptance rate from `start` to `end`

    Parameters
    ----------
    x : np.ndarray
        - If it is a numpy array, just do regular slicing
    start, end : int
        - start and end indices

    Returns
    -------
    list(float)
        This is an array of the acceptance rates over the trace
    '''
    l = end-start
    if l == 0:
        return 0
    if type(x) == np.ndarray:
        return _sum_look_back(x[start:end])/l
    elif variables.isVariable(x):
        return _sum_look_back(x.trace[start:end])/l
    else:
        raise ValueError('`x` ({}) must be an array or a pylab Variable'.format(
            type(x)))

class _BaseKernel:
    '''This is the base Kernel jumping class for both symmetric and nonsymmetric
    jumping kernels.

    ###########################################################################
    For nonsymmetric proposals:
    The proposal normalization (proposal_norm) attribute is defined as
        $\frac
            {P_{prop}(x^{(-1)})}
            {P_{prop}(x^{(*)})}$
    where $P_{prop}(x)$ is the pdf of the proposal distribution at x

    Assuming that the jumping probability is defined as:
        $r = \frac{P(x^{(*)})}{P(x^{(-1)})}$
    You multiply r by `self.proposal_norm`. This is unnecessary for symmetric
    proposals.
    ###########################################################################

    Parameters
    ----------
     x : pylab.variables.Variable
            - Variable we are doing the Metropolis-Hasting steps on
    '''
    def __init__(self, x):
        if not variables.isVariable(x):
            raise ValueError('`x` ({}) must be a pylab Variable'.format(type(x)))

        raise NotImplementedError('Need to change')
        self.x = x
        self._n_accepted_temp = 0
        self._n_accepted_total = 0
        self._prev_value = None
        self.proposal = None
        self._value = None

        # Set metropolis pointer for node object itself
        x._metropolis = self

    @property
    def value(self):
        return self._value

    def acceptance_rate(self, prev=None):
        '''Calculate the acceptance rate over the previous iterations.

        It does this by looking at the previous time step and seeing if the
        value is different. If it is different then it accepted, if not
        the proposal got rejected.

        Parameters
        ----------
        prev : int, None, Optional
            - Calculate the acceptance rate based on the most recent `prev` iterations
            - If this is not specified, it will calculate the acceptance rate over all
              iterations
        '''
        if self.x.sample_iter == 0:
            return 0
        if prev is None:
            return self._n_accepted_total / self.x.sample_iter
        else:
            start = int(np.max([0, self.x.sample_iter - prev]))
            end = self.x.sample_iter

            return acceptance_rate(self.x, start, end)

    def step(self):
        '''Make a Metropolis-Hastings step
        '''
        self._prev_value = self.x.value
        self.x.value = self._propose()
        self._value = None

    def proposal_norm(self, log=True):
        '''Calculate the proposal normalization factor to multiply (or add) the
        acceptance ratio r

        Parameters
        ----------
        log : bool
            - If True, return the normalization factor in log space
            - If False, do not return in log space
        '''
        if self.value is not None:
            accept = 'accepted' if self.value else 'rejected'
            raise MathError('You already {} the proposal ({metropolis.value = True}), ' \
                'you can only calculate the proposal normalization factor if you have ' \
                'not already {} the value'.format(accept,accept))
        if not util.isbool(log):
            raise ValueError('`log` ({}) must be of type bool'.format(type(log)))

        if log:
            func = self.proposal.logpdf
        else:
            func = self.proposal.pdf
        self.proposal.mean.value = self._prev_value
        self.proposal.value = self.x.value
        forward = func()

        self.proposal.mean.value = self.x.value
        self.proposal.value = self._prev_value
        reverse = func()

        if log:
            return reverse - forward
        else:
            return reverse/forward

    def accept(self):
        '''Accept the new value
        '''
        self._n_accepted_temp += 1
        self._n_accepted_total += 1
        self._value = True
        self._prev_value = None

    def reject(self):
        '''Revert to original value
        '''
        self.x.value = self._prev_value
        self._value = False
        self._prev_value = None


class _TunableKernel(_BaseKernel):
    '''Class for tuning the variance of the distribution
    
    Parameters
    ----------
    tune : int, bool, Optional
        - If an int, this is the tuning interval to adjust the scaling over the
            iterations
        - If a bool,
            - If True we set the tuning interval to 50
            - If False we do not tune
        - Example, if you want to tune the scaling every 50 iterations, set `tune`=50
        - If None, we do no tuning
    target_acceptance_rate : float (0,1), str, Optional
        - If it is a string:
            - Options:
                - 'fixed'
                    - Set the target rate to be 0.44
                - 'range'
                    - Set the target range to be between 0.2-0.5
                - 'auto'
                    - Set to 'fixed'
                - 'default'
                    - Set to the default
        - If it is a float:
            - A float indicating the target acceptance rate
            - The default value is 0.44 - the optimal value for single variable Metropolis-
                Hastings steps [1]. If the acceptance rate is below the target, it will
                scale the variance by 2/3. If the acceptance rate is above the target, it
                will scale the variance by 3/2.
        - If None, it will adapt the scale with the following rules (taken from PyMC3):
                Rate    Variance adaptation
                ----    -------------------
                <0.001        x 0.1
                <0.05         x 0.5
                <0.2          x 0.9
                >0.5          x 1.1
                >0.75         x 2
                >0.95         x 10
        - Only necessary is `tune` is not None
    end_tuning : str, int, float, None, Optional
        - When to end the tuning
        - If int
            - This is the iteration to stop the tuning
        - If str
            - Options
                - 'after burnin'
                    - Ends the tuning after the burnin period
                - 'half burnin'
                    - Ends tuning half way through burnin
                - 'auto'
                    - Set to 'half burnin'
                - 'default'
                    - Set to the default
        If float
            - Must be in (0,1), which represents the percent of burnin to tune
                over. If `end_tuning`*`burnin` is not an int, it will round down.
        - If None, set to 'default'
        - Only necessary is `tune` is not None
    start_tuning : int
        This is the iteration to start the tuning process

    References
    ----------
    [1] A. Gelman, H. S. Stern, J. B. Carlin, D. B. Dunson, A. Vehtari, and D. B. Rubin,
    Bayesian Data Analysis Third Edition. Chapman and Hall/CRC, 2013.
    '''
    def __init__(self, x, tune=None, target_acceptance_rate='default', end_tuning='default', 
        start_tuning=0):
        _BaseKernel.__init__(self, x=x)

        self._scaling = 1
        if tune is not None:
            if util.isbool(tune):
                if tune:
                    self.tune = 50
                else:
                    tune = None
                    self.tune = float('inf')
            elif not util.isint(tune):
                raise ValueError('`tune` ({}) must be a bool or an int'.format(type(tune)))
            else:
                self.tune = tune
        else:
            self.tune = float('inf')

        if tune is not None:
            if target_acceptance_rate is not None:
                if type(target_acceptance_rate) == str:
                    if target_acceptance_rate == 'default':
                        target_acceptance_rate = DEFAULT_TARGET_ACCEPTANCE_RATE
                    if target_acceptance_rate in ['auto', 'fixed']:
                        target_acceptance_rate = 0.44
                    elif target_acceptance_rate == 'range':
                        target_acceptance_rate = None
                    else:
                        raise ValueError('`target_acceptance_rate` ({}) not recognized'.format(
                            target_acceptance_rate))
                elif util.isfloat(target_acceptance_rate):
                    if target_acceptance_rate <= 0 or target_acceptance_rate >=1:
                        raise ValueError('`target_acceptance_rate` ({}) must be between 0 and 1'.format(
                            target_acceptance_rate))

            if util.isint(end_tuning):
                # if end_tuning > self.x.n_samples:
                #     raise ValueError('`end_tuning` ({}) cannot be greater than the total ' \
                #         'number of inference steps ({})'.format(end_tuning, self.x.n_samples))
                if end_tuning < 0:
                    raise ValueError('`end_tuning` ({}) cannot be negative'.format(end_tuning))
            elif util.isfloat(end_tuning):
                if end_tuning < 0 or end_tuning > 1:
                    raise ValueError('`end_tuning` ({}) must be between 0 and 1'.format(end_tuning))
                end_tuning = int(end_tuning * self.x.burnin)
            elif type(end_tuning) == str:
                if end_tuning == 'default':
                    end_tuning = DEFAULT_END_TUNING
                if end_tuning == 'after burnin':
                    end_tuning = self.x.burnin
                elif end_tuning in ['auto', 'half burnin']:
                    end_tuning = int(self.x.burnin/2)
                else:
                    raise ValueError('`end_tuning` ({}) not recognized'.format(end_tuning))
            elif end_tuning is None:
                end_tuning = int(self.x.burnin/2)
            else:
                raise ValueError('`end_tuning` ({}) type not recognized'.format(type(end_tuning)))

            if not util.isint(start_tuning):
                raise ValueError('`start_tuning` ({}) must be an int'.format( 
                    type(start_tuning)))
            
        
        else:
            end_tuning = None
            target_acceptance_rate = None
            start_tuning = None

        self._steps_until_tune = self.tune
        self.target_acceptance_rate = target_acceptance_rate
        self.end_tuning = end_tuning
        self.start_tuning = start_tuning

    def step(self):
        '''Override the base `step` method to incorporate variance tuning
        Take a single step, propose a new value
        '''
        self._prev_value = self.x.value

        if self.x.sample_iter > self.start_tuning:
            if self._steps_until_tune == 0:
                self._tune_variance()
            self._steps_until_tune -= 1

        self.x.value = self._propose()
        self._value = None
        
    def _tune_variance(self):
        '''Tune the variance if applicable
        '''
        self._n_accpeted_temp = 0
        self._steps_until_tune = self.tune
        if self.x.sample_iter > self.end_tuning:
            self._steps_until_tune = float('inf')
            return
        acc_rate = self.acceptance_rate(prev=self.tune)

        # logging.info('Tuning the variance of {}. Acceptance rate: {}'.format(
        #     self.x.name, acc_rate))

        
        if self.target_acceptance_rate is None:
            raise NotImplementedError('Check the conditions?')
            if acc_rate < 0.001:
                # reduce by 90 percent
                self.proposal.var.value *= 0.1
            elif acc_rate < 0.05:
                # reduce by 50 percent
                self.proposal.var.value *= 0.5
            elif acc_rate < 0.2:
                # reduce by ten percent
                self.proposal.var.value *= 0.9
            elif acc_rate > 0.95:
                # increase by factor of ten
                self.proposal.var.value *= 10.0
            elif acc_rate > 0.75:
                # increase by double
                self.proposal.var.value *= 2.0
            elif acc_rate > 0.5:
                # increase by ten percent
                self.proposal.var.value *= 1.1
        else:
            # print('acc_rate', acc_rate)
            if acc_rate > self.target_acceptance_rate:
                # print('increase')
                self.proposal.var.value *= 2
            else:
                # print('decrease')
                self.proposal.var.value /= 2


class NormalKernel(_TunableKernel):
    '''This is either a normal or truncated normal proposal to use for the
    proposal. If `low` and `high` are both None, it assumes it is a normal
    distribution. Else it is a truncated distribution

    Parameters
    ----------
    x : pylab.variables.Variable
        - Variable we are tuning
    var : numeric (float,int)
        - Variance for the proposal
    low, high : numeric, Optional
        - If specified makes the jumping distribution a truncated distribution
    '''
    def __init__(self, x, var, low=None, high=None, **kwargs):
        _TunableKernel.__init__(self, x=x, **kwargs)

        if not util.isnumeric(var):
            raise ValueError('`var` ({}) must be a numeric type (float, int)'.format(
                type(var)))
        if var  <= 0:
            raise ValueError('`var` ({}) must be greater than 0'.format(var))

        name = self.x.name + '_proposal'
        if low is None and high is None:
            self.proposal = variables.Normal(mean=0, var=var, G=self.x.G, name=name)
        else:
            if low is not None:
                if not util.isnumeric(low):
                    raise ValueError('If `low` ({}) is specified, it must be a numeric type (float, int)'.format(
                        type(low)))
            else:
                low = float('-inf')
            if high is not None:
                if not util.isnumeric(high):
                    raise ValueError('If `high` ({}) is specified, it must be a numeric type (float, int)'.format(
                        type(high)))
            else:
                high = float('inf')
            self.proposal = variables.TruncatedNormal(mean=0, var=var, low=low, high=high,
                G=self.x.G, name=name)

    def _propose(self):
        '''propose a new value. Sets the mean to the value of x
        '''
        self.proposal.mean.value = self.x.value
        return self.proposal.sample()
</code></pre>
  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="pylab.metropolis.DEFAULT_END_TUNING" class="name">var <span class="ident">DEFAULT_END_TUNING</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="pylab.metropolis.DEFAULT_TARGET_ACCEPTANCE_RATE" class="name">var <span class="ident">DEFAULT_TARGET_ACCEPTANCE_RATE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="pylab.metropolis.acceptance_rate">
    <p>def <span class="ident">acceptance_rate</span>(</p><p>x, start, end)</p>
    </div>
    

    
  
    <div class="desc"><p>Calculate the acceptance rate from <code>start</code> to <code>end</code></p>
<h2>Parameters</h2>
<p>x : np.ndarray
    - If it is a numpy array, just do regular slicing
start, end : int
    - start and end indices</p>
<h2>Returns</h2>
<p>list(float)
    This is an array of the acceptance rates over the trace</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pylab.metropolis.acceptance_rate', this);">Show source &equiv;</a></p>
  <div id="source-pylab.metropolis.acceptance_rate" class="source">
    <pre><code>def acceptance_rate(x, start, end):
    '''Calculate the acceptance rate from `start` to `end`

    Parameters
    ----------
    x : np.ndarray
        - If it is a numpy array, just do regular slicing
    start, end : int
        - start and end indices

    Returns
    -------
    list(float)
        This is an array of the acceptance rates over the trace
    '''
    l = end-start
    if l == 0:
        return 0
    if type(x) == np.ndarray:
        return _sum_look_back(x[start:end])/l
    elif variables.isVariable(x):
        return _sum_look_back(x.trace[start:end])/l
    else:
        raise ValueError('`x` ({}) must be an array or a pylab Variable'.format(
            type(x)))
</code></pre>
  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="pylab.metropolis.isMetropKernel">
    <p>def <span class="ident">isMetropKernel</span>(</p><p>a)</p>
    </div>
    

    
  
    <div class="desc"><p>Checks if <code>a</code> is a MetropolisKernel</p>
<h2>Parameters</h2>
<p>a : any
    Instance we are checking</p>
<h2>Returns</h2>
<p>bool
    True if <code>a</code> is a MetropolisKernel</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pylab.metropolis.isMetropKernel', this);">Show source &equiv;</a></p>
  <div id="source-pylab.metropolis.isMetropKernel" class="source">
    <pre><code>def isMetropKernel(a):
    '''Checks if `a` is a MetropolisKernel

    Parameters
    ----------
    a : any
        Instance we are checking

    Returns
    -------
    bool
        True if `a` is a MetropolisKernel
    '''
    return a is not None and issubclass(a.__class__, _BaseKernel)
</code></pre>
  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="pylab.metropolis.NormalKernel" class="name">class <span class="ident">NormalKernel</span></p>
      
  
    <div class="desc"><p>This is either a normal or truncated normal proposal to use for the
proposal. If <code>low</code> and <code>high</code> are both None, it assumes it is a normal
distribution. Else it is a truncated distribution</p>
<h2>Parameters</h2>
<p>x : pylab.variables.Variable
    - Variable we are tuning
var : numeric (float,int)
    - Variance for the proposal
low, high : numeric, Optional
    - If specified makes the jumping distribution a truncated distribution</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pylab.metropolis.NormalKernel', this);">Show source &equiv;</a></p>
  <div id="source-pylab.metropolis.NormalKernel" class="source">
    <pre><code>class NormalKernel(_TunableKernel):
    '''This is either a normal or truncated normal proposal to use for the
    proposal. If `low` and `high` are both None, it assumes it is a normal
    distribution. Else it is a truncated distribution

    Parameters
    ----------
    x : pylab.variables.Variable
        - Variable we are tuning
    var : numeric (float,int)
        - Variance for the proposal
    low, high : numeric, Optional
        - If specified makes the jumping distribution a truncated distribution
    '''
    def __init__(self, x, var, low=None, high=None, **kwargs):
        _TunableKernel.__init__(self, x=x, **kwargs)

        if not util.isnumeric(var):
            raise ValueError('`var` ({}) must be a numeric type (float, int)'.format(
                type(var)))
        if var  <= 0:
            raise ValueError('`var` ({}) must be greater than 0'.format(var))

        name = self.x.name + '_proposal'
        if low is None and high is None:
            self.proposal = variables.Normal(mean=0, var=var, G=self.x.G, name=name)
        else:
            if low is not None:
                if not util.isnumeric(low):
                    raise ValueError('If `low` ({}) is specified, it must be a numeric type (float, int)'.format(
                        type(low)))
            else:
                low = float('-inf')
            if high is not None:
                if not util.isnumeric(high):
                    raise ValueError('If `high` ({}) is specified, it must be a numeric type (float, int)'.format(
                        type(high)))
            else:
                high = float('inf')
            self.proposal = variables.TruncatedNormal(mean=0, var=var, low=low, high=high,
                G=self.x.G, name=name)

    def _propose(self):
        '''propose a new value. Sets the mean to the value of x
        '''
        self.proposal.mean.value = self.x.value
        return self.proposal.sample()
</code></pre>
  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#pylab.metropolis.NormalKernel">NormalKernel</a></li>
          <li>pylab.metropolis._TunableKernel</li>
          <li>pylab.metropolis._BaseKernel</li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="pylab.metropolis.NormalKernel.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, x, var, low=None, high=None, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Initialize self.  See help(type(self)) for accurate signature.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pylab.metropolis.NormalKernel.__init__', this);">Show source &equiv;</a></p>
  <div id="source-pylab.metropolis.NormalKernel.__init__" class="source">
    <pre><code>def __init__(self, x, var, low=None, high=None, **kwargs):
    _TunableKernel.__init__(self, x=x, **kwargs)
    if not util.isnumeric(var):
        raise ValueError('`var` ({}) must be a numeric type (float, int)'.format(
            type(var)))
    if var  <= 0:
        raise ValueError('`var` ({}) must be greater than 0'.format(var))
    name = self.x.name + '_proposal'
    if low is None and high is None:
        self.proposal = variables.Normal(mean=0, var=var, G=self.x.G, name=name)
    else:
        if low is not None:
            if not util.isnumeric(low):
                raise ValueError('If `low` ({}) is specified, it must be a numeric type (float, int)'.format(
                    type(low)))
        else:
            low = float('-inf')
        if high is not None:
            if not util.isnumeric(high):
                raise ValueError('If `high` ({}) is specified, it must be a numeric type (float, int)'.format(
                    type(high)))
        else:
            high = float('inf')
        self.proposal = variables.TruncatedNormal(mean=0, var=var, low=low, high=high,
            G=self.x.G, name=name)
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pylab.metropolis.NormalKernel.accept">
    <p>def <span class="ident">accept</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Accept the new value</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pylab.metropolis.NormalKernel.accept', this);">Show source &equiv;</a></p>
  <div id="source-pylab.metropolis.NormalKernel.accept" class="source">
    <pre><code>def accept(self):
    '''Accept the new value
    '''
    self._n_accepted_temp += 1
    self._n_accepted_total += 1
    self._value = True
    self._prev_value = None
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pylab.metropolis.NormalKernel.acceptance_rate">
    <p>def <span class="ident">acceptance_rate</span>(</p><p>self, prev=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Calculate the acceptance rate over the previous iterations.</p>
<p>It does this by looking at the previous time step and seeing if the
value is different. If it is different then it accepted, if not
the proposal got rejected.</p>
<h2>Parameters</h2>
<p>prev : int, None, Optional
    - Calculate the acceptance rate based on the most recent <code>prev</code> iterations
    - If this is not specified, it will calculate the acceptance rate over all
      iterations</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pylab.metropolis.NormalKernel.acceptance_rate', this);">Show source &equiv;</a></p>
  <div id="source-pylab.metropolis.NormalKernel.acceptance_rate" class="source">
    <pre><code>def acceptance_rate(self, prev=None):
    '''Calculate the acceptance rate over the previous iterations.
    It does this by looking at the previous time step and seeing if the
    value is different. If it is different then it accepted, if not
    the proposal got rejected.
    Parameters
    ----------
    prev : int, None, Optional
        - Calculate the acceptance rate based on the most recent `prev` iterations
        - If this is not specified, it will calculate the acceptance rate over all
          iterations
    '''
    if self.x.sample_iter == 0:
        return 0
    if prev is None:
        return self._n_accepted_total / self.x.sample_iter
    else:
        start = int(np.max([0, self.x.sample_iter - prev]))
        end = self.x.sample_iter
        return acceptance_rate(self.x, start, end)
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pylab.metropolis.NormalKernel.proposal_norm">
    <p>def <span class="ident">proposal_norm</span>(</p><p>self, log=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Calculate the proposal normalization factor to multiply (or add) the
acceptance ratio r</p>
<h2>Parameters</h2>
<p>log : bool
    - If True, return the normalization factor in log space
    - If False, do not return in log space</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pylab.metropolis.NormalKernel.proposal_norm', this);">Show source &equiv;</a></p>
  <div id="source-pylab.metropolis.NormalKernel.proposal_norm" class="source">
    <pre><code>def proposal_norm(self, log=True):
    '''Calculate the proposal normalization factor to multiply (or add) the
    acceptance ratio r
    Parameters
    ----------
    log : bool
        - If True, return the normalization factor in log space
        - If False, do not return in log space
    '''
    if self.value is not None:
        accept = 'accepted' if self.value else 'rejected'
        raise MathError('You already {} the proposal ({metropolis.value = True}), ' \
            'you can only calculate the proposal normalization factor if you have ' \
            'not already {} the value'.format(accept,accept))
    if not util.isbool(log):
        raise ValueError('`log` ({}) must be of type bool'.format(type(log)))
    if log:
        func = self.proposal.logpdf
    else:
        func = self.proposal.pdf
    self.proposal.mean.value = self._prev_value
    self.proposal.value = self.x.value
    forward = func()
    self.proposal.mean.value = self.x.value
    self.proposal.value = self._prev_value
    reverse = func()
    if log:
        return reverse - forward
    else:
        return reverse/forward
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pylab.metropolis.NormalKernel.reject">
    <p>def <span class="ident">reject</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Revert to original value</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pylab.metropolis.NormalKernel.reject', this);">Show source &equiv;</a></p>
  <div id="source-pylab.metropolis.NormalKernel.reject" class="source">
    <pre><code>def reject(self):
    '''Revert to original value
    '''
    self.x.value = self._prev_value
    self._value = False
    self._prev_value = None
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pylab.metropolis.NormalKernel.step">
    <p>def <span class="ident">step</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Override the base <code>step</code> method to incorporate variance tuning
Take a single step, propose a new value</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pylab.metropolis.NormalKernel.step', this);">Show source &equiv;</a></p>
  <div id="source-pylab.metropolis.NormalKernel.step" class="source">
    <pre><code>def step(self):
    '''Override the base `step` method to incorporate variance tuning
    Take a single step, propose a new value
    '''
    self._prev_value = self.x.value
    if self.x.sample_iter > self.start_tuning:
        if self._steps_until_tune == 0:
            self._tune_variance()
        self._steps_until_tune -= 1
    self.x.value = self._propose()
    self._value = None
</code></pre>
  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="pylab.metropolis.NormalKernel.value" class="name">var <span class="ident">value</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
